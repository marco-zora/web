@page "/playlist/{User}/{ImpiantoId}/{DeviceId}"
@using System.Net.Http.Json
@using BlazorApp1.Models
@inject HttpClient Http
@inject NavigationManager Nav

<h3>Playlist – Editor (in arrivo)</h3>

<p class="text-muted">
    User: <code>@User</code><br />
    Impianto: <code>@ImpiantoId</code><br />
    Device: <code>@DeviceId</code>
</p>

@if (Error is not null)
{
    <div class="alert alert-danger">@Error</div>
}
else if (!Loaded)
{
    <p>Caricamento…</p>
}
else
{
    <div class="alert alert-info">
        Questa pagina verrà completata in seguito. Per ora il routing e i modelli funzionano.
    </div>

    <button class="btn btn-secondary" @onclick="GoBack">Torna indietro</button>
}

@code {
    [Parameter] public string User { get; set; } = "";
    [Parameter] public string ImpiantoId { get; set; } = "";
    [Parameter] public string DeviceId { get; set; } = "";

    private string ProxyBase = "https://first.marcomaria-zora.workers.dev/api/dav/UPLOADS/";
    private const string FileName = "playlists.json";

    private PlaylistsRoot Root = new();
    private bool Loaded = false;
    private string? Error;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // carica (se esiste) oppure usa struttura vuota
            var url = ProxyBase + FileName;
            var data = await Http.GetFromJsonAsync<PlaylistsRoot>(url);
            Root = data ?? new PlaylistsRoot();

            // assicura nodo utente
            if (!Root.ContainsKey(User))
                Root[User] = new UserPlaylists();

            Loaded = true;
        }
        catch (Exception ex)
        {
            // se il file non esiste o JSON vuoto, prosegui con Root vuoto
            Root = new PlaylistsRoot();
            Error = $"Avviso: {ex.Message}";
            Loaded = true;
        }
    }

    private void GoBack() => Nav.NavigateTo($"impianto/{User}/{ImpiantoId}");
}
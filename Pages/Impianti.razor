@page "/impianti"
@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager Nav

@using BlazorApp1.Models;

<h3>Impianti</h3>

@if (!Loaded)
{
    <p>Caricamento…</p>
    return;
}

@if (Error != null)
{
    <p class="text-danger">@Error</p>
    return;
}

@if (LoggedRole == "admin")
{
    <h5>Tutti gli impianti</h5>

    @foreach (var kvp in Root!)
    {
        <h6 class="mt-3">@kvp.Key</h6>
        <ul class="list-group">
            @foreach (var imp in kvp.Value.impianti)
            {
                <li class="list-group-item">
                    <b>@imp.nome</b>
                    <div class="text-muted">@imp.indirizzo</div>
                    <span class="badge bg-secondary">@imp.monitors.Count monitor</span>
                </li>
            }
        </ul>
    }
}
else
{
    <h5>I tuoi impianti</h5>

    @if (UserData == null || UserData.impianti.Count == 0)
    {
        <p>Nessun impianto definito.</p>
    }
    else
    {
        <ul class="list-group">
            @foreach (var imp in UserData.impianti)
            {
                <li class="list-group-item">
                    <b>@imp.nome</b>
                    <div class="text-muted">@imp.indirizzo</div>
                    <span class="badge bg-secondary">@imp.monitors.Count monitor</span>
                </li>
            }
        </ul>
    }
}

@code {
    private string ProxyBase = "https://first.marcomaria-zora.workers.dev/api/dav/UPLOADS/";
    private const string FileName = "impianti.json";

    private string? LoggedUser;
    private string? LoggedRole;

    private ImpiantiRoot? Root;
    private UserImpianti? UserData;

    private bool Loaded = false;
    private string? Error;

    protected override async Task OnInitializedAsync()
    {
        LoggedUser = await JS.InvokeAsync<string>("sessionStorage.getItem", "loggedUser");
        LoggedRole = await JS.InvokeAsync<string>("sessionStorage.getItem", "loggedRole");

        if (string.IsNullOrWhiteSpace(LoggedUser))
        {
            Nav.NavigateTo("login");
            return;
        }

        await LoadImpianti();
        Loaded = true;
    }

    private async Task LoadImpianti()
    {
        try
        {
            Root = await Http.GetFromJsonAsync<ImpiantiRoot>(ProxyBase + FileName);

            if (Root == null)
            {
                Root = new ImpiantiRoot();
            }

            // Visualizzazione user
            if (LoggedRole != "admin")
            {
                if (!Root.ContainsKey(LoggedUser!))
                    Root[LoggedUser!] = new UserImpianti();

                UserData = Root[LoggedUser!];
            }
        }
        catch (Exception ex)
        {
            Error = ex.Message;
        }
    }
}
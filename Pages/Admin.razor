@page "/admin"
@inject IJSRuntime JS
@inject NavigationManager Nav
@inject HttpClient Http

<h3>Gestione utenti</h3>

@if (!Loaded)
{
    <p>Caricamento utenti...</p>
    return;
}

@if (!string.IsNullOrEmpty(Error))
{
    <p class="text-danger">@Error</p>
}

@if (Users is null || Users.Count == 0)
{
    <p>Nessun file users.json trovato.</p>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Username</th>
                <th>Hash</th>
                <th>Ruolo</th>
                <th class="text-end">Azioni</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var u in Users)
            {
                <tr>
                    <td>@u.user</td>
                    <td>@u.hash</td>
                    <td>@u.role</td>
                    <td class="text-end">
                        <button class="btn btn-danger btn-sm" @onclick="() => DeleteUser(u.user)">Elimina</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <hr />

    <h5>Aggiungi nuovo utente</h5>

    <div class="row g-2" style="max-width: 450px;">
        <div class="col">
            <input class="form-control" placeholder="Username" @bind="NewUser" />
        </div>
        <div class="col">
            <input class="form-control" placeholder="Password" type="password" @bind="NewPass" />
        </div>
        <div class="col">
            <select class="form-select" @bind="NewRole">
                <option value="user">user</option>
                <option value="admin">admin</option>
            </select>
        </div>
        <div class="col-auto">
            <button class="btn btn-success" @onclick="AddUser">Aggiungi</button>
        </div>
    </div>

    <button class="btn btn-primary mt-3" @onclick="SaveUsers">
        Salva su Nextcloud
    </button>
}

@code {
    private string ProxyBase = "https://first.marcomaria-zora.workers.dev/api/dav/UPLOADS/";
    private string FileName = "users.json";

    private class UserRecord
    {
        public string user { get; set; } = "";
        public string hash { get; set; } = "";
        public string role { get; set; } = "user";
    }

    private List<UserRecord>? Users;
    private bool Loaded = false;
    private string? Error;

    private string? NewUser;
    private string? NewPass;
    private string NewRole = "user";

    protected override async Task OnInitializedAsync()
    {
        // Gate: solo admin
        var role = await JS.InvokeAsync<string>("sessionStorage.getItem", "loggedRole");

        if (!string.Equals(role, "admin", StringComparison.Ordinal))
        {
            Nav.NavigateTo("/login");
            return;
        }

        await LoadUsersFromServer();
        Loaded = true;
    }

    private static string Sha256(string input)
    {
        using var sha = System.Security.Cryptography.SHA256.Create();
        var bytes = sha.ComputeHash(System.Text.Encoding.UTF8.GetBytes(input));
        return Convert.ToHexString(bytes).ToLowerInvariant();
    }

    private async Task LoadUsersFromServer()
    {
        try
        {
            Error = null;
            Users = await Http.GetFromJsonAsync<List<UserRecord>>(ProxyBase + FileName);
            Users ??= new(); // evita null refs
        }
        catch (Exception ex)
        {
            Error = "Errore lettura utenti: " + ex.Message;
            Users = new();
        }
    }

    private void AddUser()
    {
        if (string.IsNullOrWhiteSpace(NewUser) || string.IsNullOrWhiteSpace(NewPass))
        {
            Error = "Inserisci username e password.";
            return;
        }

        Users ??= new();
        if (Users.Any(u => u.user == NewUser))
        {
            Error = "Utente già esistente.";
            return;
        }

        Users.Add(new UserRecord
        {
            user = NewUser.Trim(),
            hash = Sha256(NewPass.Trim()),
            role = NewRole
        });

        NewUser = "";
        NewPass = "";
        NewRole = "user";
    }

    private void DeleteUser(string username)
    {
        if (Users is null) return;
        var u = Users.FirstOrDefault(x => x.user == username);
        if (u is not null) Users.Remove(u);
    }

    private async Task SaveUsers()
    {
        try
        {
            Error = null;
            Users ??= new();

            var json = System.Text.Json.JsonSerializer.Serialize(
                Users,
                new System.Text.Json.JsonSerializerOptions { WriteIndented = true }
            );

            using var content = new StringContent(json, System.Text.Encoding.UTF8, "application/json");
            var res = await Http.PutAsync(ProxyBase + FileName, content);

            if (!res.IsSuccessStatusCode)
                Error = $"Errore salvataggio: {res.StatusCode}";
            else
                await JS.InvokeVoidAsync("alert", "Utenti salvati con successo!");
        }
        catch (Exception ex)
        {
            Error = "Errore: " + ex.Message;
        }
    }
}
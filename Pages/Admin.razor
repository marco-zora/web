@page "/admin"
@inject HttpClient Http
@inject IJSRuntime JS

<h3>Gestione utenti</h3>

@if (Error is not null)
{
    <p class="text-danger">@Error</p>
}



@inject IJSRuntime JS
@inject NavigationManager Nav

@code {
    protected override async Task OnInitializedAsync()
    {
        var role = await JS.InvokeAsync<string>("sessionStorage.getItem", "loggedRole");

        if (role != "admin")
        {
            Nav.NavigateTo("/login");
            return;
        }
    }
}



@if (!Loaded)
{
    <p>Caricamento utenti...</p>
    @* Fermiamo qui finché non abbiamo letto users.json *@
    return;
}






@if (RequiresAdminLogin)
{
    <div class="card p-3 mb-3" style="max-width: 350px;">
        <h5>Accesso Admin</h5>

        @if (!string.IsNullOrEmpty(AdminError))
        {
            <p class="text-danger">@AdminError</p>
        }

        <input class="form-control mb-2" placeholder="Admin username" @bind="AdminUser" />
        <input class="form-control mb-3" type="password" placeholder="Password" @bind="AdminPass" />

        <button class="btn btn-primary" @onclick="VerifyAdminLogin">Entra</button>
    </div>

    @* Non mostriamo la pagina finché non c’è un login admin valido *@
    return;
}

@if (Users is null)
{
    <p>Nessun file users.json trovato.</p>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Username</th>
                <th>Hash</th>
                <th>Ruolo</th>
                <th class="text-end">Azioni</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var u in Users)
            {
                <tr>
                    <td>@u.user</td>
                    <td>@u.hash</td>
                    <td>@u.role</td>
                    <td class="text-end">
                        <button class="btn btn-danger btn-sm" @onclick="() => DeleteUser(u.user)">Elimina</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <hr />

    <h5>Aggiungi nuovo utente</h5>

    <div class="row g-2" style="max-width: 450px;">
        <div class="col">
            <input class="form-control" placeholder="Username" @bind="NewUser" />
        </div>
        <div class="col">
            <input class="form-control" placeholder="Password" type="password" @bind="NewPass" />
        </div>
        <div class="col">
            <select class="form-select" @bind="NewRole">
                <option value="user">user</option>
                <option value="admin">admin</option>
            </select>
        </div>
        <div class="col-auto">
            <button class="btn btn-success" @onclick="AddUser">Aggiungi</button>
        </div>
    </div>

    <button class="btn btn-primary mt-3" @onclick="SaveUsers">
        Salva su Nextcloud
    </button>
}

@code {
    private string ProxyBase = "https://first.marcomaria-zora.workers.dev/api/dav/UPLOADS/";
    private string FileName = "users.json";

    private class UserRecord
    {
        public string user { get; set; } = "";
        public string hash { get; set; } = "";
        public string role { get; set; } = "user";
    }

    private List<UserRecord>? Users;
    private bool Loaded = false;

    // Stato login admin
    private bool RequiresAdminLogin = false;
    private bool AdminLogged = false;
    private string? AdminUser;
    private string? AdminPass;
    private string? AdminError;

    private string? NewUser;
    private string? NewPass;
    private string NewRole = "user";
    private string? Error;

    private static string Sha256(string input)
    {
        using var sha = System.Security.Cryptography.SHA256.Create();
        var bytes = sha.ComputeHash(System.Text.Encoding.UTF8.GetBytes(input));
        return Convert.ToHexString(bytes).ToLower();
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadUsersFromServer();
        Loaded = true;

        if (Users != null && Users.Any(u => u.role == "admin"))
        {
            RequiresAdminLogin = true;
        }
        else
        {
            // nessun admin definito → libero accesso
            RequiresAdminLogin = false;
        }
    }

    private async Task LoadUsersFromServer()
    {
        try
        {
            Error = null;
            Users = await Http.GetFromJsonAsync<List<UserRecord>>(ProxyBase + FileName);
        }
        catch (Exception ex)
        {
            Error = "Errore lettura utenti: " + ex.Message;
        }
    }

    private async Task VerifyAdminLogin()
    {
        if (Users is null)
        {
            AdminError = "Impossibile caricare utenti.";
            return;
        }

        if (string.IsNullOrEmpty(AdminUser) || string.IsNullOrEmpty(AdminPass))
        {
            AdminError = "Inserisci username e password.";
            return;
        }

        string hash = Sha256(AdminPass);

        var admin = Users.FirstOrDefault(u => u.user == AdminUser && u.hash == hash && u.role == "admin");

        if (admin is null)
        {
            AdminError = "Credenziali admin non valide.";
            return;
        }

        // OK, admin verificato
        RequiresAdminLogin = false;
        AdminError = null;

        // Mostriamo la pagina
        StateHasChanged();
    }

    private void AddUser()
    {
        if (string.IsNullOrWhiteSpace(NewUser) || string.IsNullOrWhiteSpace(NewPass))
        {
            Error = "Inserisci username e password.";
            return;
        }

        if (Users!.Any(u => u.user == NewUser))
        {
            Error = "Utente già esistente.";
            return;
        }

        Users.Add(new UserRecord
        {
            user = NewUser.Trim(),
            hash = Sha256(NewPass.Trim()),
            role = NewRole
        });

        NewUser = "";
        NewPass = "";
        NewRole = "user";
    }

    private void DeleteUser(string username)
    {
        var u = Users?.FirstOrDefault(x => x.user == username);
        if (u != null)
            Users.Remove(u);
    }

    private async Task SaveUsers()
    {
        try
        {
            Error = null;

            var json = System.Text.Json.JsonSerializer.Serialize(
                Users,
                new System.Text.Json.JsonSerializerOptions { WriteIndented = true }
            );

            using var content = new StringContent(json, System.Text.Encoding.UTF8, "application/json");
            var res = await Http.PutAsync(ProxyBase + FileName, content);

            if (!res.IsSuccessStatusCode)
                Error = $"Errore salvataggio: {res.StatusCode}";
            else
                await JS.InvokeVoidAsync("alert", "Utenti salvati con successo!");
        }
        catch (Exception ex)
        {
            Error = "Errore: " + ex.Message;
        }
    }
}


@* 
@page "/upload"
@inject NavigationManager Nav






<h3>Carica i tuoi file</h3>

<p>
    Clicca il pulsante qui sotto per aprire la pagina di upload protetta di OneDrive.
</p>

<button class="btn btn-primary" @onclick="ApriFileRequest">
    Carica file su OneDrive
</button>





@code {
    // 👉 Incolla qui il tuo link di File Request OneDrive.
    //private string fileRequestUrl = "https://1drv.ms/u/s!XXXXXXXXXXXXXX";
    private string fileRequestUrl = "https://cnrsc-my.sharepoint.com/:f:/g/personal/marcomaria_zora_cnr_it/IgBduHaMs9w8Rrv0sGzseFl0AdC6oy9w5_UP0wngjZvbgjQ";

    string WebDavBase = "https://lisosomialipalermo.irib.cnr.it/remote.php/dav/files/api_app/UPLOADS/";
    string Username = "api_app";
    string AppPassword = "<Nextcloud-files-2026>";


    void ApriFileRequest()
    {
        // Apre il link in una nuova scheda
        Nav.NavigateTo(fileRequestUrl, forceLoad: true);
    }
}

*@

@page "/upload"
@using Microsoft.AspNetCore.Components.Forms
@inject NavigationManager Nav
@inject HttpClient Http


<h3>Carica i tuoi file</h3>

<!-- Pulsante OneDrive -->
<button class="btn btn-primary" @onclick="ApriOneDrive">
    Carica su OneDrive (File Request)
</button>

<!-- Pulsante Nextcloud -->
<label class="btn btn-secondary ms-2" for="nc-file-input">
    Scegli file e carica su Nextcloud
</label>

<InputFile id="nc-file-input" OnChange="HandleNextcloudUpload" style="display:none" />

<span class="ms-2">@Status</span>
``


@code {

    // === OneDrive ===
    private string oneDriveFileRequestUrl =
        "https://cnrsc-my.sharepoint.com/:f:/g/personal/marcomaria_zora_cnr_it/IgBduHaMs9w8Rrv0sGzseFl0AdC6oy9w5_UP0wngjZvbgjQ";

    void ApriOneDrive() =>
        Nav.NavigateTo(oneDriveFileRequestUrl, forceLoad: true);


    // === Nextcloud via Cloudflare Worker ===
    // ⚠️ Usare SEMPRE /api/dav/ alla fine
    private string ProxyBase =
        "https://first.marcomaria-zora.workers.dev/api/dav/";

    private string Status = "";


    private async Task HandleNextcloudUpload(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file is null) return;

        try
        {
            Status = "Caricamento in corso…";

            // 🔥 PATH DAV: scegliamo la cartella UPLOADS lato server
            var url = new Uri(ProxyBase + "UPLOADS/" + Uri.EscapeDataString(file.Name));

            using var stream = file.OpenReadStream(long.MaxValue);
            using var content = new StreamContent(stream);

            var res = await Http.PutAsync(url, content);

            Status = res.IsSuccessStatusCode
                ? $"Caricato su Nextcloud: {file.Name}"
                : $"Errore {(int)res.StatusCode} {res.ReasonPhrase}";
        }
        catch (Exception ex)
        {
            Status = $"Errore: {ex.Message}";
        }
    }
}
``

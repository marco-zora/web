
name: Deploy Blazor WASM to gh-pages (fallback)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

# Serve per poter pushare su gh-pages usando GITHUB_TOKEN
permissions:
  contents: write

env:
  # Cartella che CONTIENE il .csproj
  PROJECT_DIR: video-uploader/BlazorApp1
  # Nome esatto del progetto
  PROJECT_FILE: BlazorApp1.csproj
  # Cartella di output del publish
  #PUBLISH_DIR: ${{ github.workspace }}/publish/wwwroot
  PUBLISH_DIR: ${{ github.workspace }}/publish

  # URL pubblico su GitHub Pages (Blazor: base href)
  BASE_HREF: /web/video-uploader/

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'   # allineato a net10.0

      # (facoltativo) Diagnostica rapida
      - name: Dotnet info
        run: dotnet --info

      - name: Restore
        working-directory: ${{ env.PROJECT_DIR }}
        run: dotnet restore ${{ env.PROJECT_FILE }}

      - name: Build
        working-directory: ${{ env.PROJECT_DIR }}
        run: dotnet build ${{ env.PROJECT_FILE }} -c Release --no-restore

      - name: Publish
        working-directory: ${{ env.PROJECT_DIR }}
        run: dotnet publish ${{ env.PROJECT_FILE }} -c Release -o ${{ github.workspace }}/publish --no-build

      # Riscrive / -> /web/video-uploader/
      - name: Rewrite base href
        run: |
          sed -i 's|<base href="/"|<base href="${{ env.BASE_HREF }}"|g' $PUBLISH_DIR/index.html

      # SPA fallback + disattiva Jekyll (necessario per file _framework/…)
      - name: Add 404.html and .nojekyll
        run: |
          cp $PUBLISH_DIR/index.html $PUBLISH_DIR/404.html
          touch $PUBLISH_DIR/.nojekyll

      # Pubblica i file nel branch gh-pages sotto /video-uploader
      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ${{ env.PUBLISH_DIR }}
          destination_dir: video-uploader   # <<< pubblica in /video-uploader/
          force_orphan: true                # branch pulito (opzionale)
